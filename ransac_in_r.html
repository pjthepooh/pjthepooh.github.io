<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="PJ" />
        <meta name="copyright" content="PJ" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="datascience, r, samples, anomaly, outliers, Data Science, " />

<meta property="og:title" content="RANSAC in R "/>
<meta property="og:url" content="http://www.pjthepooh.com/ransac_in_r.html" />
<meta property="og:description" content="" />
<meta property="og:site_name" content="PJ the Pooh" />
<meta property="og:article:author" content="PJ" />
<meta property="og:article:published_time" content="2016-10-02T23:20:00-07:00" />
<meta property="" content="2016-10-02T23:20:00-07:00" />
<meta name="twitter:title" content="RANSAC in R ">
<meta name="twitter:description" content="">

        <title>RANSAC in R  Â· PJ the Pooh
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://www.pjthepooh.com/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://www.pjthepooh.com/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://www.pjthepooh.com/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://www.pjthepooh.com/theme/css/custom.css" media="screen">
        <link href="http://www.pjthepooh.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="PJ the Pooh - Full Atom Feed" />
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://www.pjthepooh.com/"><span class=site-name>PJ the Pooh</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://www.pjthepooh.com">Home</a></li>
                            <li ><a href="http://www.pjthepooh.com/pages/../about.html">About</a></li>
                            <li ><a href="http://www.pjthepooh.com/categories.html">Categories</a></li>
                            <li ><a href="http://www.pjthepooh.com/tags.html">Tags</a></li>
                            <li ><a href="http://www.pjthepooh.com/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://www.pjthepooh.com/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="http://www.pjthepooh.com/ransac_in_r.html"> RANSAC in R  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div id="toc"><ul><li><a class="toc-href" href="#intuition" title="Intuition">Intuition</a></li><li><a class="toc-href" href="#code" title="Code">Code</a></li><li><a class="toc-href" href="#discussion" title="Discussion">Discussion</a></li><li><a class="toc-href" href="#ending" title="Ending">Ending</a></li></ul></div>
        </nav>
    </div>
    <div class="span8 article-content">

            
            <h1 id="intuition">Intuition</h1>
<p>Random sample consensus (RANSAC) is one of the techniques that estimate model parameters while the data contains outliers. This technique is not very famous in statistical field, but has been widely used in computer vision. But why? This is also something I want to discuss in this post.</p>
<p>A year ago I was working on a project written in R, and wanted to use this technique; however, I was not able to find a package or immediate code in R, but in many other languages such as Matlab, Python and etc. RANSAC's idea is intuitive and the implementation is simple, so I decided to code it up, but I had not actually worked on it until now. </p>
<div class="highlight"><pre><span></span><span class="n">suppressWarnings</span><span class="p">(</span><span class="n">suppressPackageStartupMessages</span><span class="p">({</span>
  <span class="n">library</span><span class="p">(</span><span class="n">gridExtra</span><span class="p">)</span>
  <span class="n">library</span><span class="p">(</span><span class="n">pryr</span><span class="p">)</span>
  <span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="p">}))</span>
</pre></div>
<p>First, we need to generate a dataset with trend and noise components, where the trend is 'clean' data points with strong signal and the noise is something that will potentially damage the signal. The noise data is uniformly distributed in a square grid as you can see below. 9 datasets are generated with different noise-to-clean ratios.  </p>
<div class="highlight"><pre><span></span><span class="n">gen_dummy_data</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">noise_ratio</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">stop</span><span class="p">(</span><span class="s2">"Length of x and y have to be the same."</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">n</span> <span class="o">&lt;-</span> <span class="n">length</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">trend</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">)</span>
  <span class="n">noise</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">runif</span><span class="p">(</span><span class="n">noise_ratio</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">y</span> <span class="o">=</span> <span class="n">runif</span><span class="p">(</span><span class="n">noise_ratio</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
  <span class="n">df</span> <span class="o">&lt;-</span> <span class="n">rbind</span><span class="p">(</span><span class="n">trend</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span>
  <span class="n">df</span> <span class="o">&lt;-</span> <span class="n">df</span><span class="p">[</span><span class="n">sample</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">nrow</span><span class="p">(</span><span class="n">df</span><span class="p">)),</span> <span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">]</span>
  <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">seed</span> <span class="o">=</span> <span class="mi">1110</span>
<span class="n">m</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">x</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="p">:</span><span class="n">m</span>
<span class="n">y</span> <span class="o">&lt;-</span> <span class="n">x</span> <span class="o">+</span> <span class="n">rnorm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">noise_ratio</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="nb">set</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">df_list</span> <span class="o">&lt;-</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">arrange</span><span class="p">,</span> <span class="n">nrow</span> <span class="o">=</span> <span class="mi">3</span><span class="p">),</span> 
        <span class="n">lapply</span><span class="p">(</span><span class="n">noise_ratio</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">df</span> <span class="o">&lt;-</span> <span class="n">gen_dummy_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">noise_ratio</span> <span class="o">=</span> <span class="n">r</span><span class="p">)</span>
          <span class="n">df_list</span><span class="p">[[</span><span class="k">as</span><span class="o">.</span><span class="n">character</span><span class="p">(</span><span class="n">r</span><span class="p">)]]</span> <span class="o">&lt;&lt;-</span> <span class="n">df</span>
          <span class="n">ggplot</span><span class="p">()</span> <span class="o">+</span> 
            <span class="n">geom_point</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="o">+</span> 
            <span class="n">ggtitle</span><span class="p">(</span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"noise_ratio = </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="p">})</span>
<span class="p">)</span>
</pre></div>
<p><img alt="png" src="images/ransac_in_r/output_5_0.png"/></p>
<p>As noise ratio increases, it becomes harder to notice the trend. Let's see if RANSAC is able to detect the trend from the noisy background.</p>
<h1 id="code">Code</h1>
<p>The R code below is my own version of RANSAC which does not change its principle. This is the first draft of the code for prototype. Please review some materials (or at least <a href="https://en.wikipedia.org/wiki/Random_sample_consensus">Wikipedia</a>) about this technique for more details. </p>
<p>Note: 
<em> MAE is used for goodness of fit of a model
</em> The probablity that the algorithm selects only inliers in some iteration is set to be 0.99 to solve for the maximum number of iteration, k.
<em> The initial threshold value is set to be the median of absolute errors of a model fitted using all data points.
</em> Default noise ratio is 0.7 to derive other parameters if they are not provided.</p>
<div class="highlight"><pre><span></span><span class="c1">#' Random sample consensus (RANSAC) </span>
<span class="c1">#' </span>
<span class="c1">#' @param data dataframe with target column and model matrix columns</span>
<span class="c1">#' @param y_col name of target column</span>
<span class="c1">#' @param model model function to fit</span>
<span class="c1">#' @param model_args list, arguments to the model</span>
<span class="c1">#' @param n the minimum number of data values required to fit the model</span>
<span class="c1">#' @param k the maximum number of iterations allowed in the algorithm</span>
<span class="c1">#' @param t a threshold value for determining when a data point fits a model</span>
<span class="c1">#' @param d the number of close data values required to assert that a model fits well to data</span>
<span class="c1">#' </span>
<span class="c1">#' @return a list of output contains best fitted model, inliers, outliers </span>
<span class="c1">#' </span>
<span class="n">RANSAC</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_args</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">NA</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">NA</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">NA</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">default_ratio</span> <span class="o">=</span> <span class="mf">0.7</span> 

  <span class="n">model_args_all</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="n">model_args</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
  <span class="n">model_all</span> <span class="o">&lt;-</span> <span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">model_args_all</span><span class="p">)</span>
  <span class="n">err_abs</span> <span class="o">&lt;-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[,</span> <span class="n">y_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">predict</span><span class="p">(</span><span class="n">model_all</span><span class="p">,</span> <span class="n">newdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[,</span> <span class="n">names</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">!=</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="n">FALSE</span><span class="p">]))</span>

  <span class="k">if</span><span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">na</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">t</span> <span class="o">&lt;-</span> <span class="n">quantile</span><span class="p">(</span><span class="n">err_abs</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">na</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">d</span> <span class="o">&lt;-</span> <span class="n">nrow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">*</span><span class="n">default_ratio</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">na</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">k</span> <span class="o">&lt;-</span> <span class="k">as</span><span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.99</span><span class="p">)</span> <span class="o">/</span> <span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">default_ratio</span><span class="o">^</span><span class="n">n</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="n">mae_best</span> <span class="o">&lt;-</span> <span class="n">mean</span><span class="p">(</span><span class="n">err_abs</span><span class="p">)</span>
  <span class="n">ind</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="p">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="n">inliers</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">()</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="k">if</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">progress_pct</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">quantile</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">length</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="mi">10</span><span class="p">),</span> <span class="n">probs</span> <span class="o">=</span> <span class="n">seq</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">cat</span><span class="p">(</span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"Begin RANSAC algoritm with parameters:</span><span class="se">\n</span><span class="s2">n = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">k = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">t = </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">d = </span><span class="si">%s</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="k">while</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">k</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span><span class="ow">in</span><span class="o">%</span> <span class="n">progress_pct</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">cat</span><span class="p">(</span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"Completion percentage: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">names</span><span class="p">(</span><span class="n">progress_pct</span><span class="p">)[</span><span class="n">which</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">progress_pct</span><span class="p">)]))</span>
    <span class="p">}</span>

    <span class="n">inliers_case</span> <span class="o">&lt;-</span> <span class="n">sample</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">model_args_case</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="n">model_args</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">inliers_case</span><span class="p">,</span> <span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="n">FALSE</span><span class="p">]))</span>
    <span class="n">model_case</span> <span class="o">&lt;-</span> <span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_args_case</span><span class="p">)</span>

    <span class="n">predict_args_case</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
      <span class="nb">object</span> <span class="o">=</span> <span class="n">model_case</span><span class="p">,</span>
      <span class="n">newdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="n">inliers_case</span><span class="p">,</span> <span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="n">FALSE</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">yhat</span> <span class="o">&lt;-</span> <span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">predict</span><span class="p">,</span> <span class="n">predict_args_case</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="n">inliers_case</span><span class="p">,</span> <span class="n">y_col</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">&lt;-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yhat</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>

    <span class="n">inliers_case</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="n">inliers_case</span><span class="p">,</span> <span class="n">names</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="n">which</span><span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">)])</span>
    <span class="k">if</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">inliers_case</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">data_inliers</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="p">[</span><span class="n">inliers_case</span><span class="p">,</span> <span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="n">FALSE</span><span class="p">]</span>
      <span class="n">model_inliers_args</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="n">model_args</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data_inliers</span><span class="p">))</span>
      <span class="n">model_inliers</span> <span class="o">&lt;-</span> <span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_inliers_args</span><span class="p">)</span>

      <span class="n">predict_inliers_args_case</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">object</span> <span class="o">=</span> <span class="n">model_inliers</span><span class="p">,</span>
        <span class="n">newdata</span> <span class="o">=</span> <span class="n">data_inliers</span>
      <span class="p">)</span>
      <span class="n">mae_inliers</span> <span class="o">&lt;-</span> <span class="n">mean</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">data_inliers</span><span class="p">[,</span> <span class="n">y_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">predict</span><span class="p">,</span> <span class="n">predict_inliers_args_case</span><span class="p">)))</span>
      <span class="k">if</span><span class="p">(</span><span class="n">mae_inliers</span> <span class="o">&lt;</span> <span class="n">mae_best</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">model_best</span> <span class="o">&lt;-</span> <span class="n">model_inliers</span>
        <span class="n">mae_best</span> <span class="o">&lt;-</span> <span class="n">mae_inliers</span>
        <span class="n">inliers</span> <span class="o">&lt;-</span> <span class="n">inliers_case</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="err">!</span><span class="n">exists</span><span class="p">(</span><span class="s2">"model_best"</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">warning</span><span class="p">(</span><span class="s2">"Final model could not be found, using all data to fit the model. "</span><span class="p">)</span>
    <span class="n">model_best</span> <span class="o">&lt;-</span> <span class="n">model_all</span>
  <span class="p">}</span>
  <span class="n">model_best</span><span class="p">[</span><span class="s2">"call"</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">sprintf</span><span class="p">(</span><span class="s2">"Model with formula: </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">model_args</span><span class="p">[[</span><span class="s2">"formula"</span><span class="p">]])</span>  

  <span class="n">inliers_df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">sort</span><span class="p">(</span><span class="n">inliers</span><span class="p">),</span> <span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">]</span>
  <span class="n">outliers_df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">setdiff</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">sort</span><span class="p">(</span><span class="n">inliers</span><span class="p">)),</span> <span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">]</span>
  <span class="k">if</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cat</span><span class="p">(</span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%.1f%%</span><span class="s2">) inliers out of </span><span class="si">%s</span><span class="s2"> total data points have been used. </span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">inliers</span><span class="p">),</span> <span class="n">length</span><span class="p">(</span><span class="n">inliers</span><span class="p">)</span> <span class="o">/</span> <span class="n">nrow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">nrow</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_best</span><span class="p">,</span> <span class="n">inliers</span> <span class="o">=</span> <span class="n">inliers_df</span><span class="p">,</span> <span class="n">outliers</span> <span class="o">=</span> <span class="n">outliers_df</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
<p>Next we just loop through different scenarios. For convenience, I hard coded n=5 and k=500 here, which are supposed to be further optimized. </p>
<div class="highlight"><pre><span></span><span class="n">plot_list</span> <span class="o">&lt;-</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span><span class="p">(</span><span class="n">r</span> <span class="ow">in</span> <span class="n">noise_ratio</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">args_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[[</span><span class="k">as</span><span class="o">.</span><span class="n">character</span><span class="p">(</span><span class="n">r</span><span class="p">)]],</span>
    <span class="n">y_col</span> <span class="o">=</span> <span class="s2">"y"</span><span class="p">,</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">lm</span><span class="p">,</span>
    <span class="n">model_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">formula</span> <span class="o">=</span> <span class="s2">"y ~ x"</span><span class="p">),</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">NA</span><span class="p">,</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">m</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r</span><span class="p">),</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">FALSE</span>
  <span class="p">)</span>

  <span class="nb">set</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
  <span class="n">fit</span> <span class="o">&lt;-</span> <span class="n">RANSAC</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">args_list</span><span class="p">[[</span><span class="s2">"data"</span><span class="p">]],</span> 
                <span class="n">y_col</span> <span class="o">=</span> <span class="n">args_list</span><span class="p">[[</span><span class="s2">"y_col"</span><span class="p">]],</span> 
                <span class="n">model</span> <span class="o">=</span> <span class="n">args_list</span><span class="p">[[</span><span class="s2">"model"</span><span class="p">]],</span> 
                <span class="n">model_args</span> <span class="o">=</span> <span class="n">args_list</span><span class="p">[[</span><span class="s2">"model_args"</span><span class="p">]],</span> 
                <span class="n">n</span> <span class="o">=</span> <span class="n">args_list</span><span class="p">[[</span><span class="s2">"n"</span><span class="p">]],</span> 
                <span class="n">k</span> <span class="o">=</span> <span class="n">args_list</span><span class="p">[[</span><span class="s2">"k"</span><span class="p">]],</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">args_list</span><span class="p">[[</span><span class="s2">"t"</span><span class="p">]],</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">args_list</span><span class="p">[[</span><span class="s2">"d"</span><span class="p">]],</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="n">args_list</span><span class="p">[[</span><span class="s2">"verbose"</span><span class="p">]]</span>
  <span class="p">)</span>

  <span class="n">p</span> <span class="o">&lt;-</span> <span class="n">ggplot</span><span class="p">()</span> <span class="o">+</span>
    <span class="n">geom_point</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">args_list</span><span class="p">[[</span><span class="s2">"data"</span><span class="p">]],</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">+</span>
    <span class="n">stat_smooth</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">args_list</span><span class="p">[[</span><span class="s2">"data"</span><span class="p">]],</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">),</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">"lm"</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mf">1.2</span><span class="p">)</span> <span class="o">+</span>
    <span class="n">geom_point</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[[</span><span class="s2">"inliers"</span><span class="p">]],</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">"red"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">+</span>
    <span class="n">stat_smooth</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[[</span><span class="s2">"inliers"</span><span class="p">]],</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">),</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">"lm"</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">"green"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mf">1.2</span><span class="p">)</span> <span class="o">+</span>
    <span class="n">ggtitle</span><span class="p">(</span><span class="n">sprintf</span><span class="p">(</span><span class="s2">"noise_ratio = </span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
  <span class="n">plot_list</span><span class="p">[[</span><span class="k">as</span><span class="o">.</span><span class="n">character</span><span class="p">(</span><span class="n">r</span><span class="p">)]]</span> <span class="o">&lt;-</span> <span class="n">p</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">arrange</span><span class="p">,</span> <span class="n">nrow</span> <span class="o">=</span> <span class="mi">3</span><span class="p">),</span> <span class="n">lapply</span><span class="p">(</span><span class="n">plot_list</span><span class="p">,</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span><span class="n">x</span><span class="p">}))</span>
</pre></div>
<p><img alt="png" src="images/ransac_in_r/output_12_0.png"/></p>
<p>The blue lines are regular OLS regressions using all data points, so of course they do not fit the trend well.</p>
<p>The red points are the inliers selected by the algorithm, and the green lines are best fits.</p>
<p>As you can see, RANSAC is able to detect the trend even with high noise rate. It only fails on the last one, where noise-to-clean ratio is 10:1. If you further optimize the parameters, the algorithm may not fail.</p>
<h1 id="discussion">Discussion</h1>
<p>Going back to the question: why is RANSAC not widely used in statistics field? </p>
<p>There are strong reasons why it is being used in computer vision. There is a concept of noise in CV, where image noise should not give any information to an image. On ther other hand, RANSAC discards a large portion of data, making no attempt to accommodate the outliers. In simple word, it treats the detected outliers that genuinely don't belong to the sample, which is somehow against the philosophy of statistics. Not many statistical approaches attempt to do so. Also, there are many other well-performing robust estimation techniques that better obey statistical philosophy.</p>
<h1 id="ending">Ending</h1>
<p>RANSAC is a quick, simple, intuitive approach for many statistical analyses such as anomaly detection, forecasting, pattern recognition and etc. As people who love statistics and data, we should put it in our tool set. </p>
<p>Hope this is helpful and please let me know of any questions regarding this post.</p>
            
            <section>
<p id="comment-message">Leave your comments below. </p>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                href="http://www.pjthepooh.com/ransac_in_r.html#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'pjthepooh';
        var disqus_identifier = 'http://www.pjthepooh.com/ransac_in_r.html';
    var disqus_url = 'http://www.pjthepooh.com/ransac_in_r.html';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
            </div>
        </div>
    </div>
</div>
</section>

            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2016-10-02T23:20:00-07:00">Oct 2, 2016</time>

<h4>Last Updated</h4>
<time datetime="2016-10-02T23:20:00-07:00">Oct 2, 2016</time>

            <h4>Category</h4>
            <a class="category-link" href="http://www.pjthepooh.com/categories.html#data-science-ref">Data Science</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="http://www.pjthepooh.com/tags.html#anomaly-ref">anomaly
                    <span>1</span>
</a></li>
                <li><a href="http://www.pjthepooh.com/tags.html#datascience-ref">datascience
                    <span>2</span>
</a></li>
                <li><a href="http://www.pjthepooh.com/tags.html#outliers-ref">outliers
                    <span>1</span>
</a></li>
                <li><a href="http://www.pjthepooh.com/tags.html#r-ref">r
                    <span>1</span>
</a></li>
                <li><a href="http://www.pjthepooh.com/tags.html#samples-ref">samples
                    <span>1</span>
</a></li>
            </ul>
<h4>Keep in Touch</h4>
    <a href="mailto:pjthepooh@gmail.com" title="My Email Address" class="sidebar-social-links" target="_blank">
    <i class="fa fa-envelope sidebar-social-links"></i></a>
    <a href="https://www.linkedin.com/in/pjhuang" title="My Linkedin Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-linkedin sidebar-social-links"></i></a>
    <a href="https://www.facebook.com/peejay1110" title="My Facebook Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-facebook sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-license">&copy; PJ the Pooh 2016</li>


    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

            <script type="text/javascript">
var disqus_shortname = 'pjthepooh';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script  language="javascript" type="text/javascript">
function uncollapse() {
    if (window.location.hash.match(/^#comment-\d+$/)) {
        $('#disqus_thread').collapse('show');
    }
}
</script>
<script type="text/javascript" language="JavaScript">
uncollapse();
window.onhashchange=function(){
    if (window.location.hash.match(/^#comment-\d+$/))
        window.location.reload(true);
}
</script>
<script>
$('#disqus_thread').on('shown', function () {
    var link = document.getElementsByClassName('accordion-toggle');
    var old_innerHTML = link[0].innerHTML;
    $(link[0]).fadeOut(500, function() {
        $(this).text('Click here to hide comments').fadeIn(500);
    });
    $('#disqus_thread').on('hidden', function () {
        $(link[0]).fadeOut(500, function() {
            $(this).text(old_innerHTML).fadeIn(500);
        });
    })
})
</script>


    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>